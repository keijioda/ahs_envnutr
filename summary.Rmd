---
title: 'AHS-2 Environmental Nutrition'
output: github_document
# output: pdf_document
# header-includes:
  # - \usepackage{titling}
  # - \setlength{\droptitle}{-8em} 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Required packages
pacs <- c("tidyverse", "readxl", "tableone", "GGally", "egg", "DescTools")
sapply(pacs, require, character.only = TRUE)

# Read data ---------------------------------------------------------------

is_local <- TRUE
zipfile  <- "./data/baseline-environmental-data-per-subject-20210912.zip"
fname    <- "baseline-environmental-data-per-subject-20210912.csv"

source("dataprep.R")

```

## Dataset
* File path: `M:\Groups\Nutrition\Environmental Nutrition\AHS-2 Environment and Health`
* File Name: ``r fname``

* Includes *n* = `r nrow(ev)` subjects and
* 190 variables:
  * `analysisid`
  * Demographics:
    * Age at baseline: `agein`
    * BMI: `bmi`
    * Education, 3 levels: `edu3cat`
    * Gender: `female`
    * Race (Black/Non-Black): `black`
  * Total intake in kcal, gram and servings per day
  * 28 food groups in:
    * kcal/day: `*_kcal`
    * gram/day: `*_gram`
    * standard servings/day: `*_srv`
    * GWP (kg CO<sub>2</sub>-eq): `*_gw_kg`
    * land use (m²a): `*_lu_m2`
    * water consumption (m³): `*_wc_m3`
    * (replace * with food group name -- see below)
    
* There are 28 food groups:

```{r echo = FALSE}
fg_name
```

### Issues

* ~~Environmental variables of cereal (`cereal_gw_kg`, `cereal_lu_m2`, `cereal_wc_m3`) have all zero values. AM has been notified.~~
* ~~In the previous data, subjects with extreme kcal (<500 or >4500) were already excluded. The new data include those with < 500 kcal/day. Probably because of this, the mean kcal is much lower this time (see below). Double-check with AM. If this is correct, we can apply the restriction on our end.~~

### Changes

* More subjects (+12,000) included.
* Dietary pattern (5 groups) added.
* `pork` and `beef` intakes are now separated.
* All food group variables (`*_kcal`, `*_gram`, `*_srv`, `*_gw_kg`, `*_lu_m2`, `*_wc_m3`) were winsorized at the 99.9th percentile of each variable. Total `kcal`, `gram`, `srv`, `gw_kg`, `lu_m2`, and `wc_m3` were recalculated by summing across 28 food groups after winsorization.
* Environmental impact variables (`*_gw_kg`, `*_lu_m2`, `*_wc_m3`) were standardized to 2000 kcal/day. This was done as follows: non-zero values of each environmental variable were log-transformed (due to skewness) and then regressed on the total energy. Residuals from the regression were added by predicted values for 2000 kcal and then back-transformed to the original unit. Zero values remained zero in this process.

## Demographics

```{r echo = FALSE}
# Demographics table, unstratified
ev %>% 
  CreateTableOne(demo_vars, data = .) %>% 
  print(showAllLevels = TRUE)
```

## Total food intake
* Distributions of total intake in kcal, gram and servings per day
  * In the original data, those with kcal <500 or >4500 were already excluded. The total intake shown below was re-calculated by summing up all winsorized food group intakes.
  * The max gram intake became more reasonable after winsorizing data.

```{r echo = FALSE}
# Distribution of total intake
ev %>% 
  select(kcal, gram, srv) %>% 
  psych::describe(quant=c(.25,.75)) %>% 
  as.data.frame() %>% 
  select(min, Q0.25, median, Q0.75, max, mean, sd, skew) %>% 
  mutate_all(round, 2)
```

## Total environmental impact
* Distributions of total GWP, land use and water consumption are right-skewed:

```{r echo = FALSE, fig.height = 2.3}
# Distribution of total env impact
ev %>% 
  select(gw_kg, lu_m2, wc_m3) %>% 
  psych::describe(quant=c(.25,.75)) %>%
  as.data.frame() %>% 
  select(min, Q0.25, median, Q0.75, max, mean, sd, skew) %>% 
  mutate_all(round, 2)

ev %>% 
  select(gw_kg, lu_m2, wc_m3) %>% 
  pivot_longer(gw_kg:wc_m3, names_to = "variable", values_to = "value") %>% 
  mutate(variable = factor(variable, levels = c("gw_kg", "lu_m2", "wc_m3"))) %>% 
  # mutate_if(is.numeric, log) %>% 
  ggplot(aes(x = value)) +
  geom_histogram(bins = 50) +
  facet_wrap(~ variable, scales = "free")

```

## Distribution of environmental impact by food group

* GWP

```{r echo = FALSE}
# Descriptive stats
all_desc <- function(data, vars, digits = 2){
  data %>% 
    select(all_of(vars)) %>% 
    psych::describe(quant=c(.25,.75)) %>%
    as.data.frame() %>% 
    select(min, Q0.25, median, Q0.75, max, mean, sd, skew) %>%
    mutate_all(round, digits)
}
ev %>% all_desc(gwp_vars, digits = 3)

```

* Land use

```{r echo = FALSE}
ev %>% all_desc(lu_vars, digits = 3)
```

* Water consumption

```{r echo = FALSE}
ev %>% all_desc(wc_vars, digits = 3)
```

## Mean plots of environmental impact by food group

```{r echo = FALSE}

# Mean plots of environmental variables by food groups
MeanPlot <- function(data, vars){
  data %>% 
    select(all_of(vars)) %>% 
    summarize_all(mean) %>% 
    pivot_longer(all_of(vars), names_to = "Variable", values_to = "Mean") %>% 
    ggplot(aes(x = reorder(Variable, Mean), y = Mean)) + 
    geom_bar(stat = "identity") +
    coord_flip() +
    labs(x = "Food group")
}

```

* Mean GWP by food group: The consumption of `dairy` contributes to the largest GWP, followed by `whlgrain` and `beef`, among 28 food groups.

* Mean land use by food group: `dairy` followed by `veg`, `legumes` and `whlgrain`.

* Mean water consumption by food group: `fvjuice`, followed by `veg` and `fruit`.

```{r echo = FALSE, fig.height = 5, out.width=c('50%', '50%'), fig.show='hold'}
ev %>% MeanPlot(gwp_vars)
ev %>% MeanPlot(lu_vars)
ev %>% MeanPlot(wc_vars)
```

## Comparisons of environmental impact by dietary pattern

* Total energy-adjusted GWP (`gw_kg_std`), land use (`lu_m2_std`), and water consumption (`wc_m3_std`) by dietary pattern are shown in violin plots below. Note that the horizontal axis is on the pseudo-log scale.
* GWP and land use increase in the order of vegan < lacto-ovo < pesco < semi < non-veg.
  * The average total GWP of non-vegetarians is almost twice as high as that of vegans.
* For water consumption, vegans have the highest usage: vegan > pesco > lacto-ovo > semi > non-veg.

```{r echo = FALSE, fig.height = 5, fig.width = 10, message = FALSE}
ev_vars_std <- c("gw_kg_std", "lu_m2_std", "wc_m3_std")
ev %>% 
  pivot_longer(ev_vars_std, names_to = "variable", values_to = "value") %>% 
  mutate(variable = factor(variable, levels = ev_vars_std)) %>% 
  filter(!is.na(vegstat)) %>% 
  ggplot(aes(x = vegstat, y = value, fill = vegstat)) +
  geom_violin() +
  geom_boxplot(width = 0.1, fill = "white", outlier.shape = NA) +
  coord_flip() +
  scale_x_discrete(limits = rev(levels(ev$vegstat))) +
  scale_y_continuous(trans = scales::pseudo_log_trans(base = 10)) +
  facet_grid(~variable, scales = "free") +
  labs(x = "Dietary pattern") +
  theme(legend.position = "none")

ev %>% 
  pivot_longer(ev_vars_std, names_to = "variable", values_to = "value") %>% 
  mutate(variable = factor(variable, levels = ev_vars_std)) %>% 
  filter(!is.na(vegstat)) %>% 
  group_by(variable, vegstat) %>% 
  summarize(Median = median(value), Mean = mean(value), SD = sd(value))
```

* In all three variables, differences across dietary patterns were highly significant:

```{r echo = FALSE}
# Kruskal-Wallis to compare across vegstat
ev[ev_vars_std] %>% 
  map_dfr(\(x) broom::tidy(kruskal.test(x ~ vegstat, data = ev))) %>% 
  mutate(Variable = ev_vars_std, p.value = Hmisc::format.pval(p.value)) %>% 
  select(Variable, method, statistic, p.value)
```

## Mean plot of environmental impact of food groups by dietary pattern

* GWP

```{r echo = FALSE, message = FALSE, fig.width = 10, fig.height = 8}
# Function to produce mean, SD and median by dietary pattern
ev_desc_stats_by_vegstat <- function(data, vars, digits = 3){
  data %>% 
    pivot_longer(all_of(vars), names_to = "variable", values_to = "value") %>% 
    mutate(variable = factor(variable, levels = vars)) %>% 
    filter(!is.na(vegstat)) %>% 
    group_by(variable, vegstat) %>% 
    summarize(Median = median(value), Mean = mean(value), SD = sd(value)) %>% 
    mutate_if(is.numeric, round, digits)
}
# Mean plots of food groups by dietary pattern
mean_plot_by_vegstat <- function(data, vars){
  data %>% 
    ev_desc_stats_by_vegstat(vars) %>%
    mutate(vegstat = factor(vegstat, labels = c("V", "LO", "P", "S", "NV"))) %>% 
    ggplot(aes(x = vegstat, y = Mean, fill = vegstat)) +
    geom_bar(stat = "identity") +
    labs(x = "Dietary pattern") +
    facet_wrap(~variable, scales = "free") +
    theme(legend.position = "bottom")
}

ev %>% mean_plot_by_vegstat(gwp_vars_std)
```

* Land use

```{r echo = FALSE, message = FALSE, fig.width = 10, fig.height = 8}
ev %>% mean_plot_by_vegstat(lu_vars_std)
```

* Water consumption: Some of food groups have very small values.

```{r echo = FALSE, message = FALSE, fig.width = 10, fig.height = 8}
ev %>% mean_plot_by_vegstat(wc_vars_std)
```
